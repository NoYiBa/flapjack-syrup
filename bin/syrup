#!/usr/bin/env ruby

require 'optparse'
require 'methadone'
require 'syrup.rb'
require 'trollop'
require 'flapjack-diner'

class App
  include Methadone::Main
  include Methadone::CLILogging
  include SyrupCLI
  extend Syrup::Tools

  main do
    # Apply flapjack API path, logger information, etc.
    Flapjack::Diner.base_uri(@cli.global_args[:host]+":"+@cli.global_args[:port])
    Flapjack::Diner.logger = Logger.new(@cli.global_args[:log]) #TODO: Look at combining this with methadone's logging infra.

    # Load the methods for the appropriate object
    case @cli.object
    when 'contact'
      extend Syrup::Contact
    when 'medium'
      extend Syrup::Medium
    when 'pagerduty'
      extend Syrup::PagerDuty
    when 'rule'
      extend Syrup::Rule
    when 'entity'
      extend Syrup::Entity
    when 'check'
      extend Syrup::Check
    when nil
      Trollop::die "Need an object type"
    end

    # Get the action argument; call the appropriate method from the extension loaded above
    self.method(@cli.action.gsub('-','_')).call(@cli.action_args)
  end

    @cli = Cli.new
    @cli.parse


  use_log_level_option :toggle_debug_on_signal => 'USR1'

  go!
end
